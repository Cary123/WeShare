<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pdsu.education.model.News">
    <resultMap id="newsMap" type="News">
        <id column="pk_id" property="id"/>
        <result column="title" property="title"/>
        <result column="content_type_id" property="contentTypeId"/>
        <result column="picture" property="image"/>
        <result column="content" property="content"/>
        <result column="modified" property="updateTime"/>
        <result column="range_id" property="age"/>
        <result column="type_id" property="contentType"/>
        <result column="name" property="typeName"/>
    </resultMap>
    <insert id="createNews" parameterType="News" useGeneratedKeys="true" keyProperty="id">
        <![CDATA[
            INSERT INTO
                message(title, content_type_id, picture, content, modified)
            VALUES
                (#{title}, #{contentTypeId}, #{image}, #{content}, Now())
        ]]>
    </insert>
    <select id="getNewsCount" resultType="Integer" parameterType="String">
        <![CDATA[
            SELECT
                count(pk_id)
            FROM
                message
            WHERE
                title
            LIKE
                #{keyword}
            AND
                deleted = false
        ]]>
    </select>
    <select id="queryAllNews" resultMap="newsMap" parameterType="map">
        <![CDATA[
            SELECT 
                a.pk_id, a.title, a.content_type_id, a.picture, a.content, a.modified, b.range_id, b.type_id
            FROM
                message AS a,age_content AS b 
            WHERE 
                a.content_type_id = b.id
            AND
                a.title 
            LIKE
                #{keyword}
            AND
                a.deleted = false
            ORDER BY
                a.modified DESC
            LIMIT
                #{pageSize}
            OFFSET
                #{offset}
        ]]>
    </select>
    <select id="queryHotNews" resultMap="newsMap" parameterType="int">
        <![CDATA[
	            SELECT 
				  t.pk_id, t.title,  t.content_type_id, t.picture, t.content, substring_index(group_concat(t.modified),',',1) modified, t.range_id,  t.type_id, t.name
				FROM(
					SELECT 
							a.pk_id, a.title, a.content_type_id, a.picture, a.content, a.modified, b.range_id, b.type_id, c.name
					FROM
							message AS a,age_content AS b,education_type AS c  
					WHERE 
							a.content_type_id = b.id
					AND
	                        b.type_id = c.id
					AND
							a.deleted = false
					ORDER BY type_id ASC,modified DESC
				) AS t
				GROUP BY content_type_id
        ]]>
    </select>
    <select id="queryNewsByAgeId" resultMap="newsMap" parameterType="int">
        <![CDATA[
			SELECT 
					a.pk_id, a.title, a.content_type_id, a.picture, a.content, a.modified, b.range_id, b.type_id, c.name
			FROM
					message AS a,age_content AS b,education_type AS c  
			WHERE 
					a.content_type_id = b.id
			AND
                       b.type_id = c.id
			AND
					a.deleted = false
			AND
			        b.id > #{ageId}
			ORDER BY type_id ASC,modified DESC
        ]]>
    </select>
    <select id="getContentTypeId" resultType="Integer" parameterType="map">
        <![CDATA[
            SELECT
                id
            FROM
                age_content
            WHERE
                range_id = #{age}
            AND
                type_id = #{type}
        ]]>
    </select>
    <select id="getNewsById" parameterType="int" resultMap="newsMap">
        <![CDATA[
            SELECT
                a.pk_id, a.title, a.content_type_id, a.picture, a.content, a.modified, b.range_id, b.type_id, c.name
            FROM
                message AS a,age_content AS b,education_type AS c
            WHERE
                a.content_type_id = b.id
            AND
	            b.type_id = c.id
	        AND
				a.deleted = false
            AND
                a.pk_id = #{newsId}
        ]]>
    </select>
    <select id="getNewsByType" parameterType="int" resultMap="newsMap">
        <![CDATA[
            SELECT
                a.pk_id, a.title, a.content_type_id, a.picture, a.content, a.modified, b.range_id, b.type_id, c.name
            FROM
                message AS a,age_content AS b,education_type AS c
            WHERE
                a.content_type_id = b.id
            AND
	            b.type_id = c.id
	        AND
				a.deleted = false
            AND
                b.type_id = #{typeId}
            ORDER BY a.modified DESC
        ]]>
    </select>
</mapper>
